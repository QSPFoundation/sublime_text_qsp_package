# Препроцессор

## Некоторые особенности работы препроцессора

### Сочетания режимов

#### `pp` + `no include`

Когда препроцессор включен, но последующие строки исключаются из файла это не отменяет выполнения директив. Т.е. директивы при таком сочетании продолжают выполняться!

#### `pp` + `savecomm`

Когда препроцессор включен, но и работает сохранение спецкомментариев, спецкомментарии не обрабатываются и не исключаются из конечного файла.

#### `no pp`

Когда препроцессор выключен, не обрабатываются спецкомментарии и директивы, и сохраняются в файле.

#### `no loc`

Когда локация не открыта, все строки исключаются из конечного файла вне зависимости от других режимов, но директивы препроцессора продолжают выполняться, если препроцессор включен.

## TODO

### Блоки замены

Блоки замены нужны, чтобы поменять на релизе какие-то значения. Пока что мне нужно это для замены констант, реализованных через функции.

```qsps
!@pp:change
!@rn
!@pp:by
!"
!"
!@pp:endchange
```

Это должно применяться на полном проходе по всем файлам, по идее. Т.е. препроцессор после обработки всех файлов должен пробегаться по всем строкам и проводить замену. Однако, мне кажется правильнее переложить это на постпроцессор.

### Вложенные блоки условий

Пока не было настолько сложных проектов, чтобы в них возникла необходимость.

### Объявление нескольких меток и множественное присваивание

```qsps
!@pp:var(name, layer1, em_arr_print)
!@pp:var(name, age = August, 123)
```

Острой необходимости пока нет. Добавить можно позже, парсить, как выражения с запятыми.

### Константы

Сейчас константы реализованы через функции, как отмечено выше. Однако, было бы неплохо объявить константы в командах препроцессора.

Как это может выглядеть, чтобы не требовался доп-анализ.

```qsps
! объявляем константу:

!@pp:const(br = "<br>")

! используем в выражении
*pl @br + @br + @br
```

То есть константы по-прежнему записываются, как неявный вызов `func`, что не даст записать в них какие-то данные. Подобная запись легко парсится, и если препроцессор отключен, такие константы могут спокойно работать, используя уже написанные для них функции.

## Старое /удалить/
### Токены

- `!@` - спецкомментарий
- `!@<` - спецкомментарий с удалением строки кода
- `!@pp:` - директива препроцессора
	- `on` - включить препроцессинг
	- `off` - выключить препроцессинг
	- `savecomm` - сохранять спецкомментарии
	- `nosavecomm` - удалять спецкомментарии
	- `var` - объявить переменную (метку)
	- `nopp` - выключить препроцессор до конца файла
	- `if` - оператор условия
	- `:` - оператор `then`, т.е. что делать, если условие выполнено.
	- `endif` - оператор, завершающий условие
	- `or` - бинарный оператор ИЛИ
	- `and` - бинарный оператор И
	- `not` - бинарный оператор НЕ
	- `exclude` - исключить нижеследующее
	- `include` - включить нижеследующее
	- `(...)` - скобки для выделения операторов присваивания, сравнения и т.п.
	- `==` - сравнение на равенство
	- `!=` - сравнение на неравенство
	- `\w+` - имя переменной (метки)
	- `"..."` - строка (если распознано, директива не работает)
	- `'...'` - строка (если распознано, директива не работает)
	- `.+` - любой набор символов, кроме токенов (директива не работает)
- `"..."` - строка в кавычках
- `'...'` - строка в апострофах
- ??? `{...}` - open_brace, close_Brace