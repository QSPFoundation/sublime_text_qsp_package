# Препроцессор

Препроцессор - это набор команд предобработки исходного текста программы перед компиляцией. В нашем случае, до того, как мы сконвертируем файлы проекта в конечные файлы "`.qsp`", мы можем исключить из этих файлов некоторые строки, или рекомбинировать их.

Препроцессор написан с нуля, поэтому будут баги и логические ошибки в работе команд. Я ни разу не пользовался сторонними препроцессорами, поэтому могу изобрести велосипед там, где все гоняют на Kawasaki z900. Будьте аккуратны и делайте побольше коммитов.

**При препроцессинге билдер работает в несколько раз медленнее.**

## Cинтаксические правила

### Общее

1. Директивы препроцессора (далее "директивы") записываются в отдельных строках кода, однако допускается преформатирование, т.е. отступы в начале строки перед директивой.
2. Спецкомментарии записываются, как обычные комментарии QSP, в т.ч. они могут быть многострочными.
3. Спецкомментарии не учитываются внутри строк, фигурных скобок, а так же в конце обычных комментариев.
4. Директивы, записанные внутри строк и фигурных скобок, валидны и нормально работают.
5. Директивы записанные в многострочных комментариях не валидны и являются частью комментария.
6. Невалидная директива воспринимается препроцессором, как спецкомментарий.
7. Блоки условий, образованные директивами препроцессора, вкладывать друг в друга нельзя.
8. Имена меток и значений могут содержать только числа, буквы и символ подчёркивания, и не должны совпадать с ключевыми словами директив препроцессора.
9. имена меток и ключевые слова регистрозависимы. `NoSaveComm` и `nosavecomm` — разные слова. Первое может быть именем метки, а второе только ключевым словом директивы препроцессора.

### Спецкомментарии

* `!@` — комментарий, начинающийся с такого сочетания символов, будет удалён при препроцессинге. (простой спец-комментарий)
* `!@<` — комментарий, начинающийся с такого сочетания символов, а так же строка, в которой стоит этот комментарий, будут удалены при препроцессинге. (спец-комментарий с удалением)

### Директивы

В начале каждой директивы записывается ключ `!@pp:`.

* `!@pp:on` — включает препроцессор до конца файла, или до специального отключения. Эта команда будет работать только в режимах "On" и "Off". См. раздел [Включение препроцессора](../../README.md#Включение%20препроцессора).
* `!@pp:off` — выключает препроцессор до конца файла. Будет работать только в режимах "On" и "Off". См. раздел [Включение препроцессора](<../../README.md#Включение препроцессора>)
* `!@pp:savecomm` - данная команда **отключает** обработку специальных комментариев. То есть и специальные комментарии и те строки, которые помечались такими комментариями под удаление не будут удаляться. Действует до конца файла.
* `!@pp:nosavecomm` - данная команда **включает** обработку специальных комментариев. Действует до конца файла.
* `!@pp:var(name=123)` - данная команда объявляет метку *name* со значением **"123"**. Имена меток и значения могут содержать только числа, буквы и символ подчёркивания. Допустимо объявлять метку без указания значения: `var(layer)`.
* `!@pp:if(name==123):exclude` - данная команда проверяет, выполняется ли условие в скобках (содержит ли метка *name* значение **"123"**), и если условие выполняется, исключает нижеследующие строки кода из конечного файла. Вместо слова `exclude` можно использовать другие ключевые слова (в любых комбинациях):
	* `exclude` — **исключить** последующие строки **из конечного файла** при выполнении условия. Если условие не будет выполнено, строки будут обработаны препроцессором и включены в конечный файл.
	* `include` — последующие строки должны быть **включены в конечный файл** при выполнении условия, при этом строки будут обработаны препроцессором. Если условие не будет выполнено, строки не будут включены в конечный файл.
	* `off` - выключить препроцессор до конца блока условия. При этом не будут обрабатываться директивы и спец-комментарии.
	* `on` - до конца блока условия, даже если строки исключаются из файла, они будут обработаны препроцессором, т.е. выполнятся все директивы внутри блока условия.
	* `savecomm` — не обрабатывать специальные комментарии.
	* `nosavecomm` — обрабатывать специальные комментарии.
	Можно комбинировать ключевые слова (например, `exclude off` и `include off`).
	Содержимое скобок при проверке условия может содержать следующие операции (в порядке повышения приоритета):
	* `or` — логическое **ИЛИ**. Проверка верно ли хотя бы одно условие.
	* `and` — логическое **И**. Проверка, верны ли оба условия одновременно.
	* `not` — логическое **НЕТ**. Верно, если выражение неверно.
	* `==` — проверка равны ли два значения. Верно если равны.
	* `!=` — проверка не равны ли два значения. Верно если не равны. Приоритет такой же, как у `==`.
* `!@pp:endif` - данная команда указывает окончание блока условия.

## Некоторые особенности работы препроцессора

### Сочетания режимов

#### `pp` + `no include`

Когда препроцессор включен, но последующие строки исключаются из файла это не отменяет выполнения директив. Т.е. директивы при таком сочетании продолжают выполняться!

#### `pp` + `savecomm`

Когда препроцессор включен, но и работает сохранение спецкомментариев, спецкомментарии не обрабатываются и не исключаются из конечного файла.

#### `no pp`

Когда препроцессор выключен, не обрабатываются спецкомментарии и директивы, и сохраняются в файле.

#### `no loc`

Когда локация не открыта, все строки исключаются из конечного файла вне зависимости от других режимов, но директивы препроцессора продолжают выполняться, если препроцессор включен.

### Следует учесть
1. Препроцессор не просто вырезает и вставляет строки, он фактически разбирает ваш код на составляющие, а потом по новой собирает его. Будьте внимательны, некоторые пробелы между операторами, разделёнными `&` могут пропасть.
2. Все команды препроцессора удаляются из конечного файла при препроцессинге. Есть исключения, когда обработка отключается по вашему желанию.
3. Специальные комментарии не обрабатываются внутри кавычек и фигурных скобок.
4. Сломанные команды препроцессора считаются спец-комментариями.
5. Все объявленные метки будут глобальны для всего проекта. Будьте внимательны при организации работы препроцессора.
6. ВЛОЖЕННОСТЬ БЛОКОВ УСЛОВИЙ НЕ ПОДДЕРЖИВАЕТСЯ!
7. `True` и `False` — это метки, которые определены заранее по умолчанию. Их нельзя переопределить. Используются, как значения для проверки существования метки: `if(build_em!=True)` или `if(build_em==False)`. Однако рекомендую проверять наличие метки, написав просто: `if(build_em)`.
8. При обработке препроцессором все строки между локациями убираются из конечного файла. Это немного ускоряет конвертирование при сборке.
9. Если вы используете многострочные текстовые значения в команде QSP, а в конце записан спец-комментарий с удалением, удалится не только строка с таким спец-комментарием, но и вся команда.

Примеры:

```qsps
! команда dynamic и всё содержимое фигурных скобок будут удалены на этапе сборки
dynamic {
	123*567
} & !@< удалить команду

! здесь будут удалены все команды, начиная с clr
clr & cla & *clear & pl "Многострочный
вывод в окно
дополнительного описания" & !@<
```

## Ошибки при работе препроцессора

![errors](pp-errors.png)

На скриншоте выше видно, что теперь препроцессор выводит в консоль список ошибок, которые вы допустили при написании директивы, или если нарушен базовый синтаксис QSP на локации. В основном вы будете видеть ошибки вроде тех, что показаны на скриншоте. Под списком ошибок указывается название файла, в котором они были допущены.

В зависимости от типа ошибки вы можете увидеть одну из рекомендаций:
- Если проблема с файлом игры, препроцессор рекомендует '**Prove game-file.**'.
  В некоторых типах ошибок указывается в какой строке и символе стоит поискать проблему: `(44, 5)` — сорок пятая строка, шестой символ. Нумерация строк и символов у препроцессора начинается от нуля, в то время, как в интерфейсе Sublime Text по умолчанию строки нумеруются с 1.
- Если проблема в самом препроцессоре (например, я не учёл какую-то особенность синтаксиса), препроцессор предлагает связаться со мной, написав на почту *<lex666endless@gmail.com>*. Если возникают ошибки такого рода, препроцессор отключает дальнейшую обработку файла, и локации из этого файла попадают в итоговую версию игры без изменений.

## TODO

### Блоки замены

Блоки замены нужны, чтобы поменять на релизе какие-то значения. Пока что мне нужно это для замены констант, реализованных через функции.

```qsps
!@pp:change
!@rn
!@pp:by
!"
!"
!@pp:endchange
```

Это должно применяться на полном проходе по всем файлам, по идее. Т.е. препроцессор после обработки всех файлов должен пробегаться по всем строкам и проводить замену. Однако, мне кажется правильнее переложить это на постпроцессор.

### Вложенные блоки условий

Пока не было настолько сложных проектов, чтобы в них возникла необходимость.

### Объявление нескольких меток и множественное присваивание

```qsps
!@pp:var(name, layer1, em_arr_print)
!@pp:var(name, age = August, 123)
```

Острой необходимости пока нет. Добавить можно позже, парсить, как выражения с запятыми.

### Константы

Сейчас константы реализованы через функции, как отмечено выше. Однако, было бы неплохо объявить константы в командах препроцессора.

Как это может выглядеть, чтобы не требовался доп-анализ.

```qsps
! объявляем константу:

!@pp:const(br = "<br>")

! используем в выражении
*pl @br + @br + @br
```

То есть константы по-прежнему записываются, как неявный вызов `func`, что не даст записать в них какие-то данные. Подобная запись легко парсится, и если препроцессор отключен, такие константы могут спокойно работать, используя уже написанные для них функции.

## Старое /удалить/
### Токены

- `!@` - спецкомментарий
- `!@<` - спецкомментарий с удалением строки кода
- `!@pp:` - директива препроцессора
	- `on` - включить препроцессинг
	- `off` - выключить препроцессинг
	- `savecomm` - сохранять спецкомментарии
	- `nosavecomm` - удалять спецкомментарии
	- `var` - объявить переменную (метку)
	- `nopp` - выключить препроцессор до конца файла
	- `if` - оператор условия
	- `:` - оператор `then`, т.е. что делать, если условие выполнено.
	- `endif` - оператор, завершающий условие
	- `or` - бинарный оператор ИЛИ
	- `and` - бинарный оператор И
	- `not` - бинарный оператор НЕ
	- `exclude` - исключить нижеследующее
	- `include` - включить нижеследующее
	- `(...)` - скобки для выделения операторов присваивания, сравнения и т.п.
	- `==` - сравнение на равенство
	- `!=` - сравнение на неравенство
	- `\w+` - имя переменной (метки)
	- `"..."` - строка (если распознано, директива не работает)
	- `'...'` - строка (если распознано, директива не работает)
	- `.+` - любой набор символов, кроме токенов (директива не работает)
- `"..."` - строка в кавычках
- `'...'` - строка в апострофах
- ??? `{...}` - open_brace, close_Brace